version: "3.9"

services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: nano
      POSTGRES_PASSWORD: nano
      POSTGRES_DB: nano_l1
    ports:
      - "5432:5432"
    volumes:
      - ../postgres/init.sql:/docker-entrypoint-initdb.d/init.sql

  engine:
    build: ../../services/engine-go
    environment:
      ENGINE_PORT: "8080"
      DATABASE_URL: "postgres://nano:nano@db:5432/nano_l1?sslmode=disable"
      KAFKA_BROKERS: "kafka:9092"
    ports:
      - "8080:8080"
    depends_on:
      - db
      - kafka

  dashboard:
    build: ../../services/dashboard-react
    environment:
      VITE_WS_URL: "ws://localhost:8080/ws"
    ports:
      - "5173:5173"
    depends_on:
      - engine

  backtest:
    build: ../../services/backtest-py
    environment:
      ENGINE_URL: "http://engine:8080/order"
      DATA_PATH: "/data/sample/sample_ticks.csv"
    volumes:
      - ../../data:/data
    depends_on:
      - engine

  kafka:
    image: bitnami/kafka:3.7
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - ALLOW_PLAINTEXT_LISTENER=yes
    ports:
      - "9092:9092"
